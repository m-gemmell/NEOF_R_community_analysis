# (PART\*) Taxonomy {-}

# Taxa relative abundance

In this section we are going to create taxonomy bar charts.
For this we are going to use relative abundance tables of different taxa levels; Genus, Family, & Phyla.

In this chapter we are going to create a `phyloseq` object with relative abundance values of genera. 
We would use our read depth filtered data if we wanted to use it for other downstream analyses.
But, as stated in the last chapter all our samples looked good so we will use our original abundance `phyloseq` object.

## Taxa relative abundance: setup

The first steps before analysis are:

- Create a new notebook called __"3-taxonomy_barcharts"__.
  - We will use this to create our phyloseq objects and taxonomy bar charts.
- Add a markdown cell with the first level header: `# Taxonomy bar charts`.
- Add the below to a code cell to load in the `phyloseq` object and libraries.
```{r, eval=FALSE}
#Libraries
library("phyloseq")
library("microbiome")
#Load phyloseq object
load("phyloseq.RData")
```

From now on you will get less instructions on your notebook structure. 
Please create your own coding and markdown cells where you think appropriate.

## Relative abundance transformation

Now that we have the data loaded we can create a new `phyloseq` object by transforming the abundance values to relative abundances.

This is carried out with the `microbiome` function `transform()`. With it we transform the ASV abundance table within to a "compositional" table (relative abundance). 

Run the below command in an appropriate place in your notebook:

```{r, eval=FALSE}
#Transform abundance table to a relative abundance (compositional) table
pseq_relabund <- microbiome::transform(pseq, "compositional")
```

As always it is good to check the contents of the new ASV table.

```{r, eval=FALSE}
#Summarise and check sample counts which should each amount to 1
microbiome::summarize_phyloseq(pseq_relabund)
microbiome::readcount(pseq_relabund)
```

You will notice the read count for each sample is __1__. This abundance table contains fractional relative abundances for each ASV. This fraction is relative to the total abundance within each sample. Therefore, all the fractional relative abundance values of ASVs in one sample total 1.

We will use this to produce all our different taxa tables.

## Aggregate taxa

To produce a taxa table we can use the `microbiome` function `aggregate_taxa()`.

Run the below command to produce a genus based `phyloseq` object.

__Reminder__: You may want a markdown cell to create a 2nd level header for this genus section.

```{r, eval = FALSE}
#Check head of tax_table
#This will tell us the taxa level names on the column names
head(tax_table(pseq_relabund))
#Genus phyloseq
genus_pseq <- microbiome::aggregate_taxa(pseq_relabund, "Genus", verbose = FALSE)
```

Let's check our genus `phyloseq`.

```{r, eval=FALSE}
#Head of genus relative abundance table
head(phyloseq::otu_table(genus_pseq))
#Number of genera
paste0("Number of genera: ", nrow(phyloseq::otu_table(genus_pseq)))
#Summarise
microbiome::summarize_phyloseq(genus_pseq)
microbiome::readcount(genus_pseq)
```

## Taxa Relative abundance: summary

We have produced a `phyloseq` object containing a Genus relative abundance table. Next, we will create a taxonomy bar chart with this.
